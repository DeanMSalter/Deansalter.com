<template id="imgManipulatorTemplateSrc">

  <body>
    <div id="imgManipulator-container" tabindex="0">

      <button id="toggleGrid">Toggle Grid </button>
    </div>
    <style>
      #imgManipulator-container{
        display:grid;
        grid-template-columns:80% 20%;
        grid-template-rows:1fr;
        width:100%;
        height:100%;
      }
      #toggleGrid{
        grid-column-start: 2;
        grid-column-end: 2;
        grid-row-start:1;
        grid-row-end:1;
        height:10%;
        width:40%;
      }
      #newCanvas{
        grid-column-start: 1;
        grid-column-end: 1;
        grid-row-start:1;
        grid-row-end:1;
        height:100%;
        width:100%;
      }
      #gridCanvas{
        grid-column-start: 1;
        grid-column-end: 1;
        grid-row-start:1;
        grid-row-end:1;
        height:100%;
        width:100%;
      }
      #marker{
        border:solid;
        position:absolute;
        width:5px;
        height:5px
      }
    </style>



    <script>
      'use strict'
      let base_image = new Image();
      let ctx;
      let canvas;
      let gridCtx;
      let gridCanvas;

      let clicked = false;
      let gridOn = true


      function nearestMultiple(x,target){
        let found = false
        let subtract = x
        let subtractSteps = 0
        let addition = x
        let additionSteps = 0
        let returnValue;
        while(!found){
          while(subtract % target != 0){
            subtract -= 1
            subtractSteps ++
          }
          while(addition % target != 0){
            addition ++
            additionSteps ++
          }
          if(additionSteps>subtractSteps){
            returnValue = subtract-1
            found = true
          }else{
            returnValue = addition-1
            found = true
          }
        }
        return returnValue
      }

      function drawGrid(){
        for(let o = 0;o<gridCanvas.width;o+=8){
          gridCtx.beginPath();
          gridCtx.moveTo(o, 0);
          gridCtx.lineTo(o, gridCanvas.height);
          gridCtx.stroke();
        }
        for(let i=0;i<gridCanvas.height;i+=8){
          gridCtx.beginPath();
          gridCtx.moveTo(0, i);
          gridCtx.lineTo(gridCanvas.width, i);
          gridCtx.stroke();
        }
      }

      function createMark(xPos,yPos){
        let clickMarker = document.createElement("div")
        clickMarker.id = "marker"
        clickMarker.style.left = xPos
        clickMarker.style.top =  yPos
        clickMarker.style.zIndex = "100";
        document.getElementById("imgManipulator-container").appendChild(clickMarker)
      }

      function getClick(xClick,yClick,xScale,yScale){
        let clickPosX = parseInt((xClick)/xScale)
        let clickPosY = parseInt(( yClick)/yScale)
        return [clickPosX,clickPosY]
      }

      function removeMarkers(){
        while(document.getElementById("marker")){
          let element = document.getElementById("marker");
          element.parentNode.removeChild(element);
        }
      }

      function doEffect(xPos,yPos,clickWidth,clickHeight){
        removeMarkers()
        document.getElementById("gridCanvas").style.visibility = "hidden";
        invertBox(xPos+1,yPos+1,clickWidth+1,clickHeight+1,true,false,false,false)
        if(gridOn){
          document.getElementById("gridCanvas").style.visibility = "visible";
          gridOn = true;
        }else{
          document.getElementById("gridCanvas").style.visibility = "hidden";
          gridOn = false;
        }
      }

      function clickCanvas(e){
        //Get the difference between the ratio between pixels the canvas is using and the pixels that its displaying
        let xScale = canvas.clientWidth/canvas.width
        let yScale = canvas.clientHeight/canvas.height

        //Get the position of the click relative to this ratio
        let xClick = parseInt((e.clientX)/xScale)
        let yClick = parseInt((e.clientY)/yScale)

        //Find the nearest grid point
        xClick = parseInt(nearestMultiple(xClick,8)*xScale)
        yClick = parseInt(nearestMultiple(yClick,8)*yScale)

        createMark(xClick,yClick)


        if(!clicked){
          clicked = true;
          let click= getClick(xClick,yClick,xScale,yScale)
          let clickX1 = click[0]
          let clickY1 = click[1]
        }else{
          let click= getClick(xClick,yClick,xScale,yScale)
          let clickX2 = click[0]
          let clickY2 = click[1]

          let clickWidth = Math.abs(clickX2-clickX1)
          let clickHeight = Math.abs(clickY2-clickY1)

          xPos = clickX1
          yPos = clickY1
          if(clickX2 < clickX1){
            xPos = clickX2
          }
          if(clickY2 < clickY1){
            yPos = clickY2
          }

          clickWidth = nearestMultiple(clickWidth,8)+1
          clickHeight = nearestMultiple(clickHeight,8)+1

          doEffect(xPos,yPos,clickWidth,clickHeight)

          clicked = false;
       }
      }


      document.getElementById("toggleGrid").addEventListener("click",function(){
        if(!gridOn){
          document.getElementById("gridCanvas").style.visibility = "visible";
          gridOn = true;
        }else{
          document.getElementById("gridCanvas").style.visibility = "hidden";
          gridOn = false;
        }
      })

      base_image.src = 'testImage.png';
      base_image.onload = function(){

        canvas = document.createElement('canvas');
        canvas.width =  base_image.width;
        canvas.height = base_image.height;
        canvas.id = "newCanvas";

        ctx = canvas.getContext("2d");

        gridCanvas = document.createElement('canvas');
        gridCanvas.width =  base_image.width;
        gridCanvas.height = base_image.height;
        gridCanvas.id = "gridCanvas";

        gridCtx = gridCanvas.getContext("2d");
        gridCtx.lineWidth = 1;
        gridCtx.strokeStyle = "rgba(215, 44, 44, 0.5)";

        drawGrid()
        ctx.drawImage(base_image,0,0);

        gridCanvas.addEventListener('click',function(e){
          clickCanvas(e)
        });
        canvas.addEventListener('click',function(e){
          clickCanvas(e)
        });

        document.getElementById("imgManipulator-container").appendChild(canvas)
        document.getElementById("imgManipulator-container").appendChild(gridCanvas)
      }


      function colourBox(xPos, yPos,width,height,r,g,b,a){
        let imgData = ctx.getImageData(xPos, yPos, width, height);
        let currentRow=0;

        let updateRowInterval = setInterval(updateRow, 1);
        let pixelsInRow = width*4;

        function updateRow() {
          for (let o = currentRow * pixelsInRow; o < (currentRow * pixelsInRow) + pixelsInRow; o += 4) {
            if(r){
              imgData.data[o] = r;
            }
            if(g){
              imgData.data[o+1] = g;
            }
            if(b){
              imgData.data[o+2] = b;
            }
            if(a){
              imgData.data[o+3] = a;
            }

          }
          ctx.putImageData(imgData, xPos, yPos);
          if (currentRow+1 < height) {
            currentRow++
          }else{
            clearInterval(updateRowInterval)
          }
        }
      }
      function invertBox(xPos, yPos,width,height,r,g,b,a){
        let imgData = ctx.getImageData(xPos, yPos, width, height);
        let currentRow=0;

        let updateRowInterval = setInterval(updateRow, 1);
        let pixelsInRow = width*4;

        function updateRow() {
          for (let o = currentRow * pixelsInRow; o < (currentRow * pixelsInRow) + pixelsInRow; o += 4) {
            if(r){
              imgData.data[o] = 255 - imgData.data[o];
            }
            if(g){
              imgData.data[o+1] = 255 - imgData.data[o+1];
            }
            if(b){
              imgData.data[o+2] = 255 - imgData.data[o+2];
            }
            if(a){
              imgData.data[o+3] = 255 - imgData.data[o+3];
            }

          }
          ctx.putImageData(imgData, xPos, yPos);
          if (currentRow+1 < height) {
            currentRow++
          }else{
            clearInterval(updateRowInterval)
          }
        }
      }
    </script>
  </body>
</template>

 <script>
  const getFourWallSquashImport = document.querySelector('#imgManipulatorTemplate');
  const getFourWallSquashContent = getFourWallSquashImport.import.querySelector('#imgManipulatorTemplateSrc')
  document.body.appendChild(document.importNode(getFourWallSquashContent, true));
  const clonedFourWallSquash = getFourWallSquashContent.content.cloneNode(true);
  document.getElementById("imgManipulator").appendChild(clonedFourWallSquash);
  // for(let i=0;i<width;i++){ //Rows
  //   for(o=i*(width*4);o<i*(width*4)+(width*4);o+=4){//pixels in current row
  //         imgData.data[o] = 255
  //   }
  //   ctx.putImageData(imgData, xPos, yPos);
  // }
</script>
